<!DOCTYPE html>
<html>
<head>
    <style>
.menu {
    display: none;
}

.term {
    display: none;
    font-family: monospace;
}

.term table {
    border-collapse: collapse;
    background-color: black;
}

.term td {
    padding: 0px;
}
    </style>
    <script>
var colors = [
    "#000000",
    "#ff0000",
    "#00ff00",
    "#ffff00",
    "#0000ff",
    "#ff00ff",
    "#00ffff",
    "#ffffff",
];
var url = location.origin.replace(/^http/, 'ws') + "/-/";
socket = new WebSocket(url);
socket.onopen = function (e) {
    socket.send(JSON.stringify({"type": "request_streamer_list"}));
};
socket.onmessage = function (e) {
    console.log(e.data);
    var data = JSON.parse(e.data);
    var type = data.type;

    if (type == "streamer_list") {
        document.querySelector('.term').style.setProperty('display', 'none');
        var menudiv = document.querySelector('.menu');
        var menu = '<ul>';
        data.streamers.forEach(function (streamer) {
            menu += '<li><a href="#" onclick=' + "'socket.send(JSON.stringify({\"type\": \"start_watching\", \"who\": \"" + streamer.id + "\"}))'" + '>' + streamer.name + '</a></li>';
        });
        menu += '</ul>';
        menudiv.innerHTML = menu;
        menudiv.style.setProperty('display', 'block');
    }
    else if (type == "redraw_screen") {
        document.querySelector('.menu').style.setProperty('display', 'none');
        var termdiv = document.querySelector('.term');
        term = '<table class="screen">';
        data.screen.forEach(function (row) {
            term += '<tr>';
            row.forEach(function (cell) {
                term += '<td';
                if (cell.fgcolor || cell.bgcolor) {
                    term += ' style="';
                    if (cell.fgcolor) {
                        term += 'color: ' + colors[cell.fgcolor] + ';';
                    }
                    if (cell.bgcolor) {
                        term += 'background-color: ' + colors[cell.bgcolor] + ';';
                    }
                    term += '"';
                }
                term += '>';
                if (cell.contents == " " || cell.contents == "") {
                    term += "&nbsp;";
                }
                else {
                    term += cell.contents;
                }
                term += '</td>';
            });
            term += '</td>';
        });
        term += '</table>';
        termdiv.innerHTML = term;
        termdiv.style.setProperty('display', 'block');
    }
    else if (type == "update_screen") {
        var termtable = document.querySelector('.term tbody');
        data.updates.forEach(function (update) {
            var tr = termtable.children[update.row];
            var td = tr.children[update.col];
            var contents = update.cell.contents;
            if (contents == " " || contents == "") {
                contents = "&nbsp;";
            }
            td.innerHTML = contents;
            if (update.cell.fgcolor) {
                td.style.setProperty('color', colors[update.cell.fgcolor]);
            }
            else {
                td.style.setProperty('color', "#FFFFFF");
            }
            if (update.cell.bgcolor) {
                td.style.setProperty('background-color', colors[update.cell.bgcolor]);
            }
            else {
                td.style.removeProperty('background-color');
            }
        })
    }
    else if (type == "streamer_disconnect") {
        socket.send(JSON.stringify({"type": "request_streamer_list"}));
    }
};
    </script>
</head>
<body>
    <div class="menu"></div>
    <div class="term"></div>
</body>
</html>
